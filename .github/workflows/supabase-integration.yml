name: Supabase Integration

# Optimized workflow - only runs on main and develop branches to reduce CI costs
# Includes caching and concurrency controls for better performance

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

# Prevent multiple simultaneous runs of the same workflow
concurrency:
  group: supabase-${{ github.ref }}
  cancel-in-progress: true

jobs:
  setup-database:
    name: Setup Supabase Database
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cache Supabase CLI
        uses: actions/cache@v4
        with:
          path: ~/.supabase
          key: ${{ runner.os }}-supabase-cli-${{ hashFiles('**/supabase/**') }}
          restore-keys: |
            ${{ runner.os }}-supabase-cli-
            ${{ runner.os }}-supabase-

      - name: Set up Supabase CLI
        run: |
          # Check if already installed to avoid redundant installation
          if ! command -v supabase &> /dev/null; then
            echo "Installing Supabase CLI..."
            curl -fsSL https://deb.supabase.com/install.sh | sh
          else
            echo "Supabase CLI already installed: $(supabase --version)"
          fi

      - name: Validate Supabase Configuration
        run: |
          if [ -z "${{ secrets.SUPABASE_ACCESS_TOKEN }}" ]; then
            echo "Warning: SUPABASE_ACCESS_TOKEN not set. Skipping database operations."
            exit 0
          fi

      - name: Sync Database Schema
        if: success()
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          # Only push if there are actual schema changes
          if supabase db diff 2>&1 | grep -q "No changes"; then
            echo "No database changes detected"
          else
            echo "Pushing database changes..."
            supabase db push
          fi

      # Removed dangerous db reset operation that could destroy production data
      # For testing, use a separate test database or manual operations
